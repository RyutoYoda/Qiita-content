---
title: '時系列データ分析の強化と落とし穴: ラグ特徴量と移動平均特徴量の使い方'
tags:
  - Python
  - 機械学習
  - 時系列解析
  - データサイエンス
  - 特徴量エンジニアリング
private: false
updated_at: '2024-02-11T18:15:50+09:00'
id: 7bce0b401fbcb3bf9da7
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに
時系列データを用いた予測モデルの構築では、過去の情報を利用して未来を予測することが一般的です。この過程で、ラグ特徴量や移動平均特徴量をデータに追加することは、予測モデルの性能を向上させる有効な手段です。しかし、これらの特徴量を導入する際には、データリークのリスクを避けるために注意が必要です。この記事では、ラグ特徴量と移動平均特徴量の生成方法、それらが予測モデルに与える影響、そしてデータリークを防ぐための注意点について解説します。

## サンプルデータの作成
分析の基礎となるサンプルデータを生成しましょう。ここでは、ある商品の10日間の売上データを想定します。
```
import pandas as pd

data = {
    'date': pd.date_range(start='2024-01-01', periods=10, freq='D'),
    'sales': [200, 220, 250, 270, 300, 310, 330, 350, 370, 390]
}
df = pd.DataFrame(data)
```
![スクリーンショット 2024-02-11 18.07.29.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3364428/300dc0bb-599a-e2c9-f6ba-99381bd12688.png)
## ラグ特徴量の追加
ラグ特徴量は、過去のデータポイントを現在の観測値に関連付ける手法です。これにより、モデルが過去の情報を活用して予測を行うのを助けます。
```
# 1日前の売上をラグ特徴量として追加
df['sales_lag_1'] = df['sales'].shift(1)
```
![スクリーンショット 2024-02-11 18.08.17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3364428/1d8f87f2-e42a-0366-874e-a5ef86b082b5.png)

## 移動平均特徴量の追加
移動平均特徴量は、過去N日間のデータポイントの平均を現在の観測値に追加することで、データの短期的なトレンドや季節性を捉えます。
```
# 過去3日間の売上の移動平均を特徴量として追加
df['sales_moving_average_3'] = df['sales'].rolling(window=3).mean()
```
![スクリーンショット 2024-02-11 18.10.28.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3364428/3280bee3-0dbb-c410-0535-6071c6196e72.png)

## データリークのリスクと注意点
特に時系列分析において、未来の情報が誤って訓練データに含まれることは「データリーク」と呼ばれ、モデルが現実の状況よりも過大に良い性能を示す原因となります。ラグ特徴量や移動平均特徴量を生成する際には、将来のデータを使用しないように注意が必要です。例えば、未来の売上データを用いてラグ特徴量や移動平均特徴量を計算すると、モデルは実際には入手不可能な情報を使って学習してしまいます。

## 対策
「正しいデータ分割」
時系列分析では、機械学習モデルの学習時、データを時間に沿って順序正しく分割し、未来のデータが訓練データセットに含まれないように気を付けます。

「適切な特徴量選択」
モデル訓練時に日付を確認し、未来の情報を含まない特徴量のみを使用することが重要です。
## まとめ
ラグ特徴量と移動平均特徴量は、時系列データ分析における強力なツールですが、それらを使用する際にはデータリークのリスクを避けるための注意が必要です。正しく特徴量を生成し、適切にデータを扱うことで、これらの特徴量はモデルの予測精度を大幅に向上させることができます。時系列分析の精度を高めつつ、データの誤用を防ぐためには、これらのガイドラインに注意してデータの準備と分析を行うことが鍵となります。
